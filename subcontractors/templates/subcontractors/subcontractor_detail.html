{% extends 'base.html' %}
{% load static %}

{% block title %}{{ subcontractor.company }} - CRM System{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ subcontractor.company }}</h1>
    <div>
      <a href="{% url 'subcontractors:update' subcontractor.id %}" class="btn btn-outline-primary me-2">
        <i class="bi bi-pencil"></i> Edit
      </a>
      <a href="{% url 'subcontractors:list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Main Info -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Subcontractor Details</h5>
          <a href="{% url 'subcontractors:update' subcontractor.id %}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-pencil"></i> Edit
          </a>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Company:</strong> {{ subcontractor.company }}</p>
              <p><strong>Head Office:</strong> {{ subcontractor.head_office|default:"Not specified" }}</p>
              <p><strong>Trade:</strong> {{ subcontractor.trade.name }}</p>
              <p><strong>Contact:</strong> {{ subcontractor.full_name }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Email:</strong> <a href="mailto:{{ subcontractor.email }}">{{ subcontractor.email }}</a></p>
              <p><strong>Mobile:</strong> {{ subcontractor.mobile|default:"Not specified" }}</p>
              <p><strong>Landline:</strong> {{ subcontractor.landline|default:"Not specified" }}</p>
              <p><strong>Website:</strong>
                {% if subcontractor.website %}
                  <a href="{{ subcontractor.website }}" target="_blank">{{ subcontractor.website }}</a>
                {% else %}
                  Not specified
                {% endif %}
              </p>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <p><strong>PQQ Status:</strong>
                {% if subcontractor.pqq_status == 'COMPLETED' %}
                  <span class="badge bg-success">Completed</span>
                {% elif subcontractor.pqq_status == 'SENT' %}
                  <span class="badge bg-warning">Sent</span>
                {% else %}
                  <span class="badge bg-secondary">Not Started</span>
                {% endif %}
              </p>
              <p><strong>Date Added:</strong> {{ subcontractor.date_added|date:"d/m/Y" }}</p>
              <p><strong>Subcontractor Score:</strong>
                {% if subcontractor.subcontractor_score %}
                  <span class="badge bg-{% if subcontractor.subcontractor_score >= 7 %}success{% elif subcontractor.subcontractor_score >= 5 %}warning{% else %}danger{% endif %}">
                    {{ subcontractor.subcontractor_score }}
                  </span>
                {% else %}
                  Not rated
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
<p><strong>Insurance Expiry:</strong>
  {% if subcontractor.insurance_expiry %}
    {{ subcontractor.insurance_expiry|date:"d/m/Y" }}
    {% if subcontractor.insurance_expiry < now.date %}
      <span class="badge bg-danger">Expired</span>
    {% endif %}
    {% if subcontractor.insurance_expiry < thirty_days_from_now %}
      <span class="badge bg-warning">Expiring Soon</span>
    {% endif %}
  {% else %}
    Not specified
  {% endif %}
</p>
              <p><strong>Meeting Booked:</strong>
                {% if subcontractor.meeting_booked %}
                  {{ subcontractor.meeting_booked|date:"d/m/Y" }}
                {% else %}
                  No meeting scheduled
                {% endif %}
              </p>
              <p><strong>Regions:</strong>
                {% if subcontractor.regions.exists %}
                  {% for region in subcontractor.regions.all %}
                    <span class="badge bg-secondary">{{ region.name }}</span>
                  {% endfor %}
                {% else %}
                  None specified
                {% endif %}
              </p>
            </div>
          </div>

          {% if subcontractor.notes %}
            <div class="mt-3">
              <h6>Notes</h6>
              <p>{{ subcontractor.notes|linebreaks }}</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Tender History -->
      <div class="card mb-4">
        <div class="card-header bg-primary">
          <h5 class="mb-0">Tender History</h5>
        </div>
        <div class="card-body">
          {% if subcontractor.tender_invitations.exists %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Project</th>
                    <th>Invitation Sent</th>
                    <th>Response</th>
                    <th>Documents Downloaded</th>
                    <th>Tender Returned</th>
                  </tr>
                </thead>
                <tbody>
                  {% for invitation in subcontractor.tender_invitations.all %}
                    <tr>
                      <td>
                        <a href="{% url 'projects:detail' invitation.project.id %}">
                          {{ invitation.project.name }}
                        </a>
                      </td>
                      <td>{{ invitation.email_sent|date:"d/m/Y" }}</td>
                      <td>
                        {% if invitation.status == 'ACCEPTED' %}
                          <span class="badge bg-success">Will Tender</span>
                        {% elif invitation.status == 'DECLINED' %}
                          <span class="badge bg-danger">Won't Tender</span>
                        {% else %}
                          <span class="badge bg-warning">Pending</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if invitation.documents_downloaded %}
                          <span class="badge bg-info">Downloaded</span>
                        {% else %}
                          <span class="badge bg-secondary">Not Downloaded</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if invitation.tender_returned %}
                          <div class="d-flex align-items-center text-success">
                            <i class="bi bi-check-circle me-1"></i>
                            <div>
                              <div class="fw-semibold">Returned</div>
                              <small class="text-muted">
                                {% if invitation.tender_returned_at %}
                                  {{ invitation.tender_returned_at|date:"d/m/Y H:i" }}
                                {% elif invitation.returned_at %}
                                  {{ invitation.returned_at|date:"d/m/Y H:i" }}
                                {% endif %}
                              </small>
                            </div>
                          </div>
                        {% else %}
                          <div class="text-muted d-flex align-items-center">
                            <i class="bi bi-clock me-1"></i>
                            <span>Not Returned</span>
                          </div>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <div class="text-muted">No tender invitations have been sent to this subcontractor yet.</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Communication History -->
      <div class="card mb-4">
        <div class="card-header bg-primary">
          <h5 class="mb-0">Communication History</h5>
        </div>
        <div class="card-body">
          {% if subcontractor.emails.exists %}
            <div class="list-group list-group-flush">
              {% for email in subcontractor.emails.all|dictsortreversed:"sent_at" %}
                <div class="list-group-item bg-secondary">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ email.subject }}</h6>
                    <small>{{ email.sent_at|date:"d/m/Y" }}</small>
                  </div>
                  <p class="mb-1 small">
                    {% if email.email_type == 'INVITATION' %}
                      <span class="badge bg-primary">Tender Invitation</span>
                    {% elif email.email_type == 'REMINDER' %}
                      <span class="badge bg-warning">Reminder</span>
                    {% elif email.email_type == 'ADDENDUM' %}
                      <span class="badge bg-info">Addendum</span>
                    {% else %}
                      <span class="badge bg-secondary">Other</span>
                    {% endif %}
                    {{ email.project.name }}
                  </p>
                  <small>
                    {% if email.opened_at %}
                      <i class="bi bi-envelope-open text-success"></i> Opened on {{ email.opened_at|date:"d/m/Y H:i" }}
                    {% else %}
                      <i class="bi bi-envelope text-muted"></i> Not opened
                    {% endif %}
                  </small>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-4">
              <div class="text-muted">No email communication history found.</div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header bg-primary">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="list-group list-group-flush">
          <a href="mailto:{{ subcontractor.email }}" class="list-group-item list-group-item-action text-black">
            <i class="bi bi-envelope me-2 text-black"></i> Send Email
          </a>
          <a href="{% url 'subcontractors:update' subcontractor.id %}" class="list-group-item list-group-item-action text-black">
            <i class="bi bi-pencil me-2 text-black"></i> Edit Subcontractor
          </a>
          <a href="{% url 'subcontractors:delete' subcontractor.id %}" class="list-group-item list-group-item-action text-danger">
            <i class="bi bi-trash me-2 text-black"></i> Delete Subcontractor
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}